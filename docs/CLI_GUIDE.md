# Keystone CLI Guide

Keystone is controlled primarily through its Command Line Interface (CLI). This guide serves as a manual for all available commands, options, and workflows for securing your credentials.

## Overview

The `keystone` binary provides commands for managing the lifecycle of your encrypted database, securely adding and retrieving credentials, managing human-in-the-loop approvals, and querying audit logs.

### Global Options

- `--help`: Print help information for any command.
- `--version`: Print the current Keystone version.

---

## Initialization

Before using Keystone, you must initialize the local vault.

### `keystone init`

Initialize the encrypted SQLCipher database and generate a secure Master Key.

```bash
cargo run -- init
```

**What it does:**

1. Generates a high-entropy cryptographically secure Master Key.
2. Stores this key safely inside your OS's native Platform Keyring (e.g., Apple Keychain, Linux Secret Service).
3. Derives a sub-key using Argon2id and creates the encrypted SQLite database (`~/.local/share/keystone/keystone.db`).

*Note: You only need to run this once per machine.*

---

## Managing Credentials

### `keystone add`

Store a new credential in the vault.

**Syntax:**

```bash
cargo run -- add [OPTIONS] --provider <PROVIDER> --intent <INTENT> --secret <SECRET>
```

**Required Arguments:**

- `--provider <PROVIDER>`: The service provider (e.g., `github`, `aws`, `openai`).
- `--intent <INTENT>`: A natural language description of what this key is used for. This text is embedded into a vector space, so be as descriptive as possible! (e.g., `"GitHub Personal Access Token with repo read scope for cloning private repositories"`).
- `--secret <SECRET>`: The raw API key, token, or password.

**Optional Guardrails:**

- `--environment <ENV>`: (Default: `development`). The environment tag (e.g., `production`, `staging`).
- `--scope-tags <TAGS>`: Comma-separated list of scopes (e.g., `"repo:read,user:email"`).
- `--require-approval`: If passed, any AI agent attempting to retrieve this key will be **blocked** until a human operator manually approves the exact request. Highly recommended for production credentials.
- `--max-ttl <DURATION>`: Automatically expire and scrub the credential after a fixed duration. Accepts formats like `1h`, `30m`, `7d`.

**Example:**

```bash
cargo run -- add \
  --provider "aws" \
  --intent "AWS access key to provision staging EC2 servers" \
  --secret "AKIAIOSFODNN7EXAMPLE" \
  --require-approval \
  --max-ttl "2h"
```

### `keystone list`

List all stored credentials.

```bash
cargo run -- list
```

**What it does:** Displays a tabular summary of all stored credentials, their environments, and their UUIDs.
*Security Note: This command never displays the raw secret values.*

### `keystone get <ID>`

Get detailed metadata about a specific credential.

```bash
cargo run -- get dfca6126-1ec7-4059-8207-9f0079cc136a
```

**What it does:** Prints the provider, scopes, attached policies (like TTL and Approvals), and timestamps.
*Security Note: The secret remains `[REDACTED]` in standard output.*

### `keystone delete <ID>`

Permanently delete a credential from the vault.

```bash
cargo run -- delete dfca6126-1ec7-4059-8207-9f0079cc136a
```

---

## Intelligence & AI Agents

### `keystone serve`

Start the Keystone background daemon. This is how AI agents communicate with your vault.

**Modes:**

- `cargo run -- serve --transport stdio`: Starts an MCP (Model Context Protocol) server over standard input/output. This is the standard way to attach Keystone to an AI agent like Claude Desktop, Cline, or Devin.
- `cargo run -- serve --transport uds`: Starts a JSON-RPC server listening on a Unix Domain Socket (usually `/tmp/keystone/keystone.sock`). Used for custom local scripts.

### `keystone search <INTENT>`

Manually test the Semantic Search engine.

```bash
cargo run -- search "deploy to production cluster"
```

**What it does:** Uses the local `fastembed` AI model to embed your search query and cosine-matches it against all your stored credential intents. It returns the top 5 matches ranked by semantic relevance value.

---

## Safety & Auditing (Guardrails)

When you attach the `--require-approval` flag to a credential, AI agents cannot access it freely. When they try, they receive an error containing a Request ID, prompting them to ask you for permission.

### `keystone approve <REQUEST_ID>`

Authorize a pending request generated by an AI agent.

```bash
cargo run -- approve 8d4eefb0-5ba2-46dc-904c-49a96285c4e0
```

**What it does:** Unblocks the specific Request ID for exactly 1 hour. The AI agent can now successfully pull the secret.

### `keystone reject <REQUEST_ID>`

Deny an access request securely.

```bash
cargo run -- reject 8d4eefb0-5ba2-46dc-904c-49a96285c4e0
```

### `keystone audit <CREDENTIAL_ID>`

View an immutable, chronological timeline of every interaction with a specific variable.

```bash
cargo run -- audit dfca6126-1ec7-4059-8207-9f0079cc136a
```

**Example Output:**

```text
Audit Log for Credential: dfca6126...
--------------------------------------------------------------------------------
[2026-02-23 09:04:04] created by 'keystone-cli'
[2026-02-23 09:41:12] approval_requested by 'uds-client' (Request ID: 8d4eefb0...)
[2026-02-23 09:45:30] secret_accessed by 'uds-client'
--------------------------------------------------------------------------------
```

*Every time an agent successfully reads your key, it leaves a permanent forensic trace in this ledger.*
